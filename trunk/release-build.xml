<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     9 Aug 2008 15:04:02                                                        

     Vanilla release build    
     
     Build vanilla archive,
     Build a patch archive,
     tag applications,
     and extract list of changed files from svn diff. 
                   
     requires:
		- JDK 1.5+
		- Ant 1.7
                   
     Damien Lebrun                                                                
     ====================================================================== -->
<project name="Vanilla release build" default="build">
    <description>
            Build vanilla,tag applications, extract list of changed files from 
    </description>

	<loadproperties srcfile="build.properties"/>
	<loadproperties srcfile="release-build.properties"/>
	<loadproperties srcfile="svn-credential.properties"/>
	<path id="project.classpath">
		<fileset dir="${tools.ant.dir}">
			<include name="**/*.jar"/>
		</fileset>
	</path>
	<typedef resource="org/tigris/subversion/svnant/svnantlib.xml" classpathref="project.classpath"/>
	<taskdef classname="net.bluecow.googlecode.ant.GoogleCodeUploadTask" classpath="${tools.ant.dir}/ant-googlecode-0.0.1.jar" name="gcupload"/>
	
    <!-- ================================= 
          target: build              
         ================================= -->
    <target name="build" depends="prepare">
    	<ant antfile="build.xml" dir="./"/>
    	<antcall target="getChanges"/>
    	<!-- <antcall target="tag"/>-->
    	
    	<!-- build changed-only-package -->
		<copy todir="${build.upgrade.dir}" verbose="true">
			<fileset dir="${build.app.dir}" includesfile="${all.changedFiles}"/>
		</copy>
    	
    	<!-- include all src files, changed or not -->
		<copy todir="${build.upgrade.js.dir}" verbose="true">
			<fileset dir="${build.js.dir}">
				<include name="src/*.js"/>
			</fileset>
		</copy>
		<copy todir="${build.upgrade.css.dir}" verbose="true">
			<fileset dir="${build.css.dir}">
				<include name="src/*.css"/>
			</fileset>
		</copy>
    	
    	<echo>Create update archive....</echo>
    	<zip basedir="${build.dir}" destfile="${dist.dir}${dist.upgrade.name}.zip" includes="${dist.upgrade.name}/**" excludes="**/js/test, **/js/test/**"/>
    	
    	<echo>Uploading packages to google code...</echo>
    	<gcupload username="${svn.user}" password="${svn.password}" projectname="lussumo-vanilla" filename="${dist.dir}${dist.name}.zip" targetfilename="${app.name}-${app.version}.zip" summary="Vanilla ${app.version}" labels="Featured, Type-Package, OpSys-All" />
    </target>
	
	<!-- - - - - - - - - - - - - - - - - - 
          target: tag                      
         - - - - - - - - - - - - - - - - - -->
    <target name="tag" depends="getAppDetails">
		<echo level="info" message="${line.separator}Tag Vanilla ${app.version}, People ${people.version} and Framework ${framework.version}."/>
    	<svn username="${svn.user}" password="${svn.password}">
			<!-- Tag Vanilla trunk-->
			<copy srcUrl="svn.app.trunk" destUrl="${svn.app.newTag}" message="Tag version ${app.version}"/>
		</svn>
    </target>
	

	<!-- - - - - - - - - - - - - - - - - - 
          target: getChanges                      
         - - - - - - - - - - - - - - - - - -->
    <target name="getChanges" depends="prepare,getAppDetails">
		<!-- Get Diff... -->

		<echo level="info" message="Get diff between ${svn.app.trunk}${svn.app.src} and ${svn.app.tags}Vanilla-${app.old_version}/${svn.app.src}..." />
		<svn>
			<diff newurl="${svn.read.app.trunk}${svn.app.src}" oldurl="${svn.read.app.tags}Vanilla-${app.old_version}/${svn.app.src}" outfile="${app.diff}"/>
		</svn>
			
		<echo level="info" message="Get list of changed files..." />
		<copy file="${app.diff}" tofile="${app.changedFiles}" overwrite="true">
			<filterchain>
				<containsregex pattern="^Index: (.*)$" replace="\1"/>
			</filterchain>
		</copy>

    </target>
	
	<!-- - - - - - - - - - - - - - - - - - 
          target: getAppDetails                      
         - - - - - - - - - - - - - - - - - -->
    <target name="getAppDetails">
		<echo>Get application names and versions...</echo>
		<loadproperties srcfile="${src.dir}appg/version.php">
			<filterchain>
				<containsregex pattern="^define.*'(.+)_(.+)'.*'([-\w\.]+)'.*$" replace="\1.\2 = \3"/>
			</filterchain>
		</loadproperties>
		<loadproperties srcfile="${src.dir}appg/version.php">
			<filterchain>
				<containsregex pattern="^.*Previous_(\w+)_version:\s*([-\w\.]+)\s*$" replace="\1.old_version = \2"/>
			</filterchain>
		</loadproperties>
		<property name="app.version"		value="${APPLICATION.VERSION}"/>
    	<property name="app.old_version"	value="${vanilla.old_version}"/>
    	<property name="svn.app.newTag" 	value="${svn.app.tags}Vanilla-${app.version}"/>
     	<property name="dist.name" value="${app.name}-${app.version}"/>
    	<property name="dist.upgrade.name" value="vanilla-upgrade-${app.old_version}-to-${app.version}"/>
    	<property name="build.upgrade.dir" value="${build.dir}${dist.upgrade.name}/"/>
    	<property name="build.app.dir" value="${build.dir}${dist.name}/"/>
    	<property name="build.js.dir" value="${build.app.dir}${js.dir}"/>
    	<property name="build.css.dir" value="${build.app.dir}${css.dir}"/>
    	<property name="build.upgrade.js.dir" value="${build.upgrade.dir}${js.dir}"/>
    	<property name="build.upgrade.css.dir" value="${build.upgrade.dir}${css.dir}"/>

		<echo>Vanilla version ${app.version} - last version: ${app.old_version}</echo>
    </target>

	<!-- - - - - - - - - - - - - - - - - - 
          target: prepare                      
         - - - - - - - - - - - - - - - - - -->
    <target name="prepare" depends="clean,getAppDetails">
		<mkdir dir="${build.diff.dir}"/>
    	<mkdir dir="${build.upgrade.dir}"/>
    </target>
	
	<!-- - - - - - - - - - - - - - - - - - 
          target: clean                      
         - - - - - - - - - - - - - - - - - -->
    <target name="clean">
		<delete dir="${build.diff.dir}"/>
    	<delete dir="${build.upgrade.dir}"/>
    </target>

</project>
